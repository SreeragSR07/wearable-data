<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wearable Device Live Data</title>
    <style>
        /* [Previous CSS styles remain exactly the same] */
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- [Previous HTML structure remains exactly the same] -->
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const apiKey = "JB035BQVNPNCBMKN";
            const channelID = "2865083";
            const defaultLat = 10.178180;  // Default location coordinates
            const defaultLon = 76.431107;
            let alertPlaying = false;
            let hasGPSFix = false; // Track if we have actual GPS data
            
            // [Previous variable declarations remain the same]
            
            async function fetchData() {
                try {
                    const response = await fetch(`https://api.thingspeak.com/channels/${channelID}/feeds/last.json?api_key=${apiKey}`);
                    const data = await response.json();
                    
                    // Update data fields
                    document.getElementById("heartRate").textContent = data.field1 || "--";
                    const accelX = parseFloat(data.field2) || 0;
                    const accelY = parseFloat(data.field3) || 0;
                    const accelZ = parseFloat(data.field4) || 0;
                    document.getElementById("accelX").textContent = accelX.toFixed(2);
                    document.getElementById("accelY").textContent = accelY.toFixed(2);
                    document.getElementById("accelZ").textContent = accelZ.toFixed(2);
                    
                    // Update GPS - use default until real GPS is available
                    if (data.field6 && data.field7) {
                        const lat = parseFloat(data.field6).toFixed(6);
                        const lon = parseFloat(data.field7).toFixed(6);
                        document.getElementById("gps").textContent = `${lat}, ${lon}`;
                        document.getElementById("locationButton").onclick = () => {
                            window.open(`https://www.google.com/maps?q=${lat},${lon}`, "_blank");
                        };
                        document.getElementById("locationButton").disabled = false;
                        hasGPSFix = true;
                    } else {
                        // Show default location while waiting for GPS
                        document.getElementById("gps").textContent = `${defaultLat}, ${defaultLon} (Default)`;
                        document.getElementById("locationButton").onclick = () => {
                            window.open(`https://www.google.com/maps?q=${defaultLat},${defaultLon}`, "_blank");
                        };
                        document.getElementById("locationButton").disabled = false;
                        hasGPSFix = false;
                    }
                    
                    // Check for emergencies (only use real GPS for restricted areas)
                    checkEmergencies(data, accelX, accelY, accelZ);
                    
                    // Update timestamp
                    document.getElementById("timestamp").textContent = data.created_at ? 
                        new Date(data.created_at).toLocaleString() : "Not available";
                        
                } catch (error) {
                    console.error("Fetch error:", error);
                    document.getElementById("errorDisplay").textContent = 
                        "Connection error - retrying...";
                    
                    // Show default location when offline
                    document.getElementById("gps").textContent = `${defaultLat}, ${defaultLon} (Offline)`;
                    document.getElementById("locationButton").onclick = () => {
                        window.open(`https://www.google.com/maps?q=${defaultLat},${defaultLon}`, "_blank");
                    };
                }
            }
            
            function checkEmergencies(data, accelX, accelY, accelZ) {
                // [Previous emergency detection logic remains the same]
                
                // Only check restricted areas if we have real GPS
                if (hasGPSFix && data.field6 && data.field7) {
                    const restrictedZone = checkRestrictedZone(parseFloat(data.field6), parseFloat(data.field7));
                    if (restrictedZone) {
                        emergencyState.restrictedArea = true;
                        emergencyState.restrictedZoneName = restrictedZone;
                    }
                }
                
                updateEmergencyDisplay();
            }
            
            // [Rest of the JavaScript remains exactly the same]
        });
    </script>
</body>
</html>
