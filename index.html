<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Wearable Device Dashboard</title>
    <style>
        /* Previous CSS remains the same */
        .emergency-active {
            animation: emergencyPulse 1s infinite;
            background-color: #ffebee;
            border: 2px solid #ff4b2b;
        }
        .emergency-text {
            color: #e74c3c;
            font-weight: bold;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Previous HTML remains the same until the script -->
    
    <script>
        const apiKey = "JB035BQVNPNCBMKN";
        const channelID = "2865083";
        const defaultLat = 10.178180;
        const defaultLon = 76.431107;
        let alertPlaying = false;
        
        // Restricted zones (latitude, longitude, radius in km)
        const restrictedZones = [
            {lat: 10.180000, lon: 76.430000, radius: 0.5, name: "Construction Site"},
            {lat: 10.185000, lon: 76.435000, radius: 0.3, name: "Restricted Area A"}
        ];
        
        // Movement tracking variables
        let lastMovementTime = Date.now();
        let lastAccelValues = {x: 0, y: 0, z: 0};
        let freeFallStartTime = null;
        let emergencyState = {
            fallDetected: false,
            freeFall: false,
            noMovement: false,
            highImpact: false,
            heartRateAlert: false,
            manualSOS: false,
            restrictedArea: false,
            lowBattery: false
        };
        
        // Calculate distance between two coordinates (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Check if location is in restricted zone
        function checkRestrictedZone(lat, lon) {
            for (const zone of restrictedZones) {
                const distance = calculateDistance(lat, lon, zone.lat, zone.lon);
                if (distance <= zone.radius) {
                    return zone.name;
                }
            }
            return false;
        }
        
        async function fetchData() {
            try {
                const response = await fetch(`https://api.thingspeak.com/channels/${channelID}/feeds/last.json?api_key=${apiKey}`);
                const data = await response.json();
                
                // Update data fields
                document.getElementById("heartRate").textContent = data.field1 || "--";
                const accelX = parseFloat(data.field2) || 0;
                const accelY = parseFloat(data.field3) || 0;
                const accelZ = parseFloat(data.field4) || 0;
                document.getElementById("accelX").textContent = accelX.toFixed(2);
                document.getElementById("accelY").textContent = accelY.toFixed(2);
                document.getElementById("accelZ").textContent = accelZ.toFixed(2);
                
                // Update GPS
                const lat = data.field6 ? parseFloat(data.field6).toFixed(6) : defaultLat;
                const lon = data.field7 ? parseFloat(data.field7).toFixed(6) : defaultLon;
                document.getElementById("gps").textContent = `${lat}, ${lon}`;
                
                // Check for emergencies
                checkEmergencies(data, accelX, accelY, accelZ, lat, lon);
                
                // Update timestamp
                document.getElementById("timestamp").textContent = data.created_at ? 
                    new Date(data.created_at).toLocaleString() : "Not available";
                    
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }
        
        function checkEmergencies(data, accelX, accelY, accelZ, lat, lon) {
            const emergencyBox = document.getElementById("emergencyBox");
            const emergencyElement = document.getElementById("emergencyStatus");
            const alertSound = document.getElementById("alertSound");
            
            // Reset emergency state
            emergencyState = {
                fallDetected: false,
                freeFall: false,
                noMovement: false,
                highImpact: false,
                heartRateAlert: false,
                manualSOS: false,
                restrictedArea: false,
                lowBattery: false
            };
            
            // 1. Manual SOS Check
            if (data.field5 === "1") {
                emergencyState.manualSOS = true;
            }
            
            // 2. Low Battery Check
            if (data.field8 === "1") {
                emergencyState.lowBattery = true;
            }
            
            // 3. Heart Rate Anomaly
            const heartRate = parseFloat(data.field1);
            if (heartRate && (heartRate < 50 || heartRate > 150)) {
                emergencyState.heartRateAlert = true;
            }
            
            // 4. High Impact Detection
            if (Math.abs(accelX) > 20 || Math.abs(accelY) > 20 || Math.abs(accelZ) > 20) {
                emergencyState.highImpact = true;
            }
            
            // 5. Fall Detection (sudden movement followed by stillness)
            const currentAccel = {x: accelX, y: accelY, z: accelZ};
            const movementThreshold = 1.0;
            
            // Check for significant movement
            if (Math.abs(accelX - lastAccelValues.x) > movementThreshold ||
                Math.abs(accelY - lastAccelValues.y) > movementThreshold ||
                Math.abs(accelZ - lastAccelValues.z) > movementThreshold) {
                lastMovementTime = Date.now();
            }
            
            // 6. No Movement Alert (30+ seconds without significant movement)
            if (Date.now() - lastMovementTime > 30000) {
                emergencyState.noMovement = true;
            }
            
            // 7. Free Fall Detection (all axes near 0)
            const freeFallThreshold = 1.5;
            if (Math.abs(accelX) < freeFallThreshold && 
                Math.abs(accelY) < freeFallThreshold && 
                Math.abs(accelZ) < freeFallThreshold) {
                
                if (!freeFallStartTime) {
                    freeFallStartTime = Date.now();
                } else if (Date.now() - freeFallStartTime > 2000) {
                    emergencyState.freeFall = true;
                }
            } else {
                freeFallStartTime = null;
            }
            
            // 8. Restricted Area Alert
            const restrictedZone = checkRestrictedZone(parseFloat(lat), parseFloat(lon));
            if (restrictedZone) {
                emergencyState.restrictedArea = true;
                emergencyState.restrictedZoneName = restrictedZone;
            }
            
            // Update last acceleration values
            lastAccelValues = currentAccel;
            
            // Determine which emergency to display (priority order)
            let emergencyMessage = "Normal";
            if (emergencyState.manualSOS) {
                emergencyMessage = "MANUAL SOS ACTIVATED!";
            } else if (emergencyState.lowBattery) {
                emergencyMessage = "BATTERY CRITICAL!";
            } else if (emergencyState.restrictedArea) {
                emergencyMessage = `RESTRICTED AREA: ${emergencyState.restrictedZoneName}`;
            } else if (emergencyState.heartRateAlert) {
                emergencyMessage = "HEART RATE ALERT!";
            } else if (emergencyState.highImpact) {
                emergencyMessage = "HIGH IMPACT DETECTED!";
            } else if (emergencyState.fallDetected) {
                emergencyMessage = "POSSIBLE FALL DETECTED!";
            } else if (emergencyState.freeFall) {
                emergencyMessage = "FREE FALL DETECTED!";
            } else if (emergencyState.noMovement) {
                emergencyMessage = "NO MOVEMENT ALERT!";
            }
            
            emergencyElement.textContent = emergencyMessage;
            
            // Handle emergency visuals and sound
            if (emergencyMessage !== "Normal") {
                emergencyBox.classList.add("emergency-active");
                emergencyElement.classList.add("emergency-text");
                if (!alertPlaying) {
                    alertSound.play().catch(e => console.log("Audio play prevented:", e));
                    alertPlaying = true;
                    setTimeout(() => { alertPlaying = false; }, 5000);
                }
            } else {
                emergencyBox.classList.remove("emergency-active");
                emergencyElement.classList.remove("emergency-text");
            }
        }
        
        // Initial fetch and then every 5 seconds
        fetchData();
        setInterval(fetchData, 5000);
    </script>
</body>
</html>
