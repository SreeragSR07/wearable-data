<script>
document.addEventListener('DOMContentLoaded', function() {
    const apiKey = "JB035BQVNPNCBMKN";
    const channelID = "2865083";
    let alertPlaying = false;
    
    // Restricted zones
    const restrictedZones = [
        {lat: 10.180000, lon: 76.430000, radius: 0.5, name: "Construction Site"},
        {lat: 10.185000, lon: 76.435000, radius: 0.3, name: "Restricted Area A"}
    ];
    
    // Movement tracking variables
    let lastMovementTime = Date.now();
    let lastAccelValues = {x: 0, y: 0, z: 0};
    let freeFallStartTime = null;
    let noMovementStartTime = null;
    let emergencyState = {
        fallDetected: false,
        freeFall: false,
        noMovement: false,
        highImpact: false,
        heartRateAlert: false,
        manualSOS: false,
        restrictedArea: false,
        lowBattery: false,
        usingRealGPS: false
    };

    // Calculate distance between coordinates
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Check restricted zones only with real GPS data
    function checkRestrictedZone(lat, lon) {
        if (!emergencyState.usingRealGPS) return false;
        
        for (const zone of restrictedZones) {
            const distance = calculateDistance(lat, lon, zone.lat, zone.lon);
            if (distance <= zone.radius) {
                return zone.name;
            }
        }
        return false;
    }

    async function fetchData() {
        try {
            const response = await fetch(`https://api.thingspeak.com/channels/${channelID}/feeds/last.json?api_key=${apiKey}`);
            const data = await response.json();
            
            // Check if we have real GPS data
            emergencyState.usingRealGPS = (data.field6 && data.field7);
            
            // Update data fields
            document.getElementById("heartRate").textContent = data.field1 || "--";
            const accelX = parseFloat(data.field2) || 0;
            const accelY = parseFloat(data.field3) || 0;
            const accelZ = parseFloat(data.field4) || 0;
            document.getElementById("accelX").textContent = accelX.toFixed(2);
            document.getElementById("accelY").textContent = accelY.toFixed(2);
            document.getElementById("accelZ").textContent = accelZ.toFixed(2);
            
            // Update GPS - only use actual data, no defaults
            if (emergencyState.usingRealGPS) {
                const lat = parseFloat(data.field6).toFixed(6);
                const lon = parseFloat(data.field7).toFixed(6);
                document.getElementById("gps").textContent = `${lat}, ${lon}`;
                
                document.getElementById("locationButton").onclick = () => {
                    window.open(`https://www.google.com/maps?q=${lat},${lon}`, "_blank");
                };
            } else {
                document.getElementById("gps").textContent = "Waiting for GPS...";
                document.getElementById("locationButton").disabled = true;
            }
            
            // Check for emergencies with real data only
            checkEmergencies(data, accelX, accelY, accelZ);
            
            // Update timestamp
            document.getElementById("timestamp").textContent = data.created_at ? 
                new Date(data.created_at).toLocaleString() : "Not available";
                
        } catch (error) {
            console.error("Fetch error:", error);
            document.getElementById("errorDisplay").textContent = 
                "Connection error - retrying...";
        }
    }

    function checkEmergencies(data, accelX, accelY, accelZ) {
        // Reset emergency state
        emergencyState = {
            ...emergencyState,
            fallDetected: false,
            freeFall: false,
            noMovement: false,
            highImpact: false,
            heartRateAlert: false,
            manualSOS: false,
            restrictedArea: false,
            lowBattery: false
        };

        // 1. Manual SOS Check
        if (data.field5 === "1") emergencyState.manualSOS = true;
        
        // 2. Low Battery Check
        if (data.field8 === "1") emergencyState.lowBattery = true;
        
        // 3. Heart Rate Anomaly
        const heartRate = parseFloat(data.field1);
        if (heartRate && (heartRate < 50 || heartRate > 150)) {
            emergencyState.heartRateAlert = true;
        }
        
        // 4-7. Movement-related checks
        checkMovementPatterns(accelX, accelY, accelZ);
        
        // 8. Restricted Area (only if we have real GPS)
        if (emergencyState.usingRealGPS) {
            const lat = parseFloat(data.field6);
            const lon = parseFloat(data.field7);
            const zone = checkRestrictedZone(lat, lon);
            if (zone) {
                emergencyState.restrictedArea = true;
                emergencyState.restrictedZoneName = zone;
            }
        }
        
        updateEmergencyDisplay();
    }

    function checkMovementPatterns(accelX, accelY, accelZ) {
        const currentAccel = {x: accelX, y: accelY, z: accelZ};
        const movementThreshold = 1.0;
        
        // Check for significant movement
        if (Math.abs(accelX - lastAccelValues.x) > movementThreshold ||
            Math.abs(accelY - lastAccelValues.y) > movementThreshold ||
            Math.abs(accelZ - lastAccelValues.z) > movementThreshold) {
            lastMovementTime = Date.now();
        }
        
        // High Impact Detection
        if (Math.abs(accelX) > 20 || Math.abs(accelY) > 20 || Math.abs(accelZ) > 20) {
            emergencyState.highImpact = true;
        }
        
        // Fall Detection (high G followed by stillness)
        if ((Math.abs(lastAccelValues.x) > 15 || 
             Math.abs(lastAccelValues.y) > 15 || 
             Math.abs(lastAccelValues.z) > 15) &&
            Math.abs(accelX) < 2 && 
            Math.abs(accelY) < 2 && 
            Math.abs(accelZ) < 2) {
            emergencyState.fallDetected = true;
        }
        
        // No Movement Alert
        if (Date.now() - lastMovementTime > 30000) {
            emergencyState.noMovement = true;
        }
        
        // Free Fall Detection
        const freeFallThreshold = 1.5;
        if (Math.abs(accelX) < freeFallThreshold && 
            Math.abs(accelY) < freeFallThreshold && 
            Math.abs(accelZ) < freeFallThreshold) {
            if (!freeFallStartTime) {
                freeFallStartTime = Date.now();
            } else if (Date.now() - freeFallStartTime > 2000) {
                emergencyState.freeFall = true;
            }
        } else {
            freeFallStartTime = null;
        }
        
        lastAccelValues = currentAccel;
    }

    function updateEmergencyDisplay() {
        const emergencyBox = document.getElementById("emergencyBox");
        const emergencyElement = document.getElementById("emergencyStatus");
        const alertSound = document.getElementById("alertSound");
        
        // Priority-based emergency message
        let emergencyMessage = "Normal";
        if (emergencyState.manualSOS) {
            emergencyMessage = "MANUAL SOS ACTIVATED!";
        } else if (emergencyState.lowBattery) {
            emergencyMessage = "BATTERY CRITICAL!";
        } else if (emergencyState.restrictedArea) {
            emergencyMessage = `RESTRICTED AREA: ${emergencyState.restrictedZoneName}`;
        } else if (emergencyState.heartRateAlert) {
            emergencyMessage = "HEART RATE ALERT!";
        } else if (emergencyState.highImpact) {
            emergencyMessage = "HIGH IMPACT DETECTED!";
        } else if (emergencyState.fallDetected) {
            emergencyMessage = "POSSIBLE FALL DETECTED!";
        } else if (emergencyState.freeFall) {
            emergencyMessage = "FREE FALL DETECTED!";
        } else if (emergencyState.noMovement) {
            emergencyMessage = "NO MOVEMENT ALERT!";
        }
        
        emergencyElement.textContent = emergencyMessage;
        
        // Visual and audio alerts
        if (emergencyMessage !== "Normal") {
            emergencyBox.classList.add("emergency-active");
            if (!alertPlaying) {
                alertSound.play().catch(e => console.log("Audio play prevented:", e));
                alertPlaying = true;
                setTimeout(() => { alertPlaying = false; }, 5000);
            }
        } else {
            emergencyBox.classList.remove("emergency-active");
        }
    }
    
    // Initial fetch and then every 5 seconds
    fetchData();
    setInterval(fetchData, 5000);
});
</script>
