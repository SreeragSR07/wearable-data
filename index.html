<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wearable Device Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* [Previous CSS remains exactly the same] */
    </style>
</head>
<body>
    <div class="container">
        <h1>Live Wearable Device Data</h1>
        <p>Last Updated: <span id="timestamp">Just now</span></p>
        
        <div class="data-grid">
            <!-- [Previous HTML structure remains the same] -->
        </div>
    </div>

    <audio id="alertSound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" preload="auto"></audio>

    <script>
        // Global variables
        let alertTimeout;
        const IMPACT_THRESHOLD = 15; // Adjust this value as needed (higher = less sensitive)
        
        // SOS state control
        let isSOSActive = false;
        const sosButton = document.getElementById('sosButton');
        const sosBox = document.getElementById('sosBox');
        const sosStatus = document.getElementById('sosStatus');
        
        // SOS button functionality
        sosButton.addEventListener('click', () => {
            isSOSActive = !isSOSActive;
            
            if (isSOSActive) {
                sosBox.classList.add('sos-active');
                sosStatus.textContent = 'SOS ACTIVATED!';
                triggerAlarm();
            } else {
                sosBox.classList.remove('sos-active');
                sosStatus.textContent = 'System Ready';
                stopAlarm();
            }
        });

        // Automatic alerts with proper impact detection
        const checkAutomaticAlerts = () => {
            const alertBox = document.getElementById('alertBox');
            const alertsText = document.getElementById('alerts');
            
            // Simulate sensor readings (replace with real data from ThingSpeak)
            const heartRate = 70 + Math.floor(Math.random() * 30);
            const accelX = (Math.random() * 20).toFixed(2);
            const accelY = (Math.random() * 20).toFixed(2);
            const accelZ = (8 + Math.random() * 4).toFixed(2);
            
            // Update displays
            document.getElementById('heartRate').textContent = heartRate;
            document.getElementById('accelX').textContent = accelX;
            document.getElementById('accelY').textContent = accelY;
            document.getElementById('accelZ').textContent = accelZ;
            
            // Check for automatic alerts with proper thresholds
            const alertMessages = [];
            
            if (heartRate > 100) alertMessages.push("High heart rate");
            if (heartRate < 50) alertMessages.push("Low heart rate");
            
            // Fixed impact detection - only triggers when values exceed threshold
            if (Math.abs(accelX) > IMPACT_THRESHOLD || 
                Math.abs(accelY) > IMPACT_THRESHOLD || 
                Math.abs(accelZ) > IMPACT_THRESHOLD) {
                alertMessages.push("High impact");
            }
            
            if (alertMessages.length > 0) {
                alertBox.classList.add('emergency');
                alertsText.textContent = alertMessages.join(' + ');
                triggerAlarm();
            } else {
                alertBox.classList.remove('emergency');
                alertsText.textContent = 'All systems normal';
            }
            
            document.getElementById('timestamp').textContent = new Date().toLocaleTimeString();
        };

        // Alarm control functions
        function triggerAlarm() {
            const alertSound = document.getElementById('alertSound');
            alertSound.play();
            // Auto-stop after 5 seconds
            alertTimeout = setTimeout(stopAlarm, 5000);
        }

        function stopAlarm() {
            const alertSound = document.getElementById('alertSound');
            alertSound.pause();
            alertSound.currentTime = 0;
            clearTimeout(alertTimeout);
        }

        // Map button functionality
        document.getElementById('mapButton').addEventListener('click', () => {
            window.open('https://www.google.com/maps?q=10.17818,76.43110');
        });

        // Initialize with proper values
        document.getElementById('accelZ').textContent = '9.81';
        
        // Update data every 10 seconds (matches Arduino interval)
        checkAutomaticAlerts();
        setInterval(checkAutomaticAlerts, 10000);
    </script>
</body>
</html>
